<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Smartlink Editor</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Telegram Web App script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* Using a dark theme inspired by the user's screenshot */
        body {
            background-color: #121212;
            color: #E0E0E0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Custom yellow color for accents */
        :root {
            --brand-yellow: #FFD23F;
            --brand-yellow-darker: #F0B42B;
        }

        /* Input field styling */
        .form-input {
            background-color: #2a2a2a;
            border: 1px solid #444;
            color: #E0E0E0;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--brand-yellow);
            box-shadow: 0 0 0 2px rgba(255, 210, 63, 0.3);
        }
        .form-input.is-invalid {
            border-color: #ef4444; /* red-500 */
        }
        .form-input.is-valid {
            border-color: #22c55e; /* green-500 */
        }

        /* Label styling */
        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #a0a0a0;
            margin-bottom: 0.5rem;
            display: block;
        }

        /* Button styling */
        .save-button {
            background-color: var(--brand-yellow);
            color: #121212;
            font-weight: bold;
            padding: 0.875rem;
            border-radius: 0.5rem;
            width: 100%;
            text-align: center;
            transition: background-color 0.2s, transform 0.1s;
            border: none;
            cursor: pointer;
        }
        .save-button:hover:not(:disabled) {
            background-color: var(--brand-yellow-darker);
        }
        .save-button:disabled {
            background-color: #444;
            color: #777;
            cursor: not-allowed;
        }
        .save-button:active:not(:disabled) {
            transform: scale(0.98);
        }

        /* Helper text for validation */
        .validation-text {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            height: 1rem; /* Reserve space to prevent layout shift */
        }
        
        /* Toast Notification for Success */
        #toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #22c55e;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: bottom 0.5s ease-in-out;
            z-index: 1000;
            display: flex;
            align-items: center;
        }
        #toast.show {
            bottom: 20px;
        }
    </style>
</head>
<body class="p-4">

    <div id="app" class="max-w-md mx-auto">
        <form id="smartlinkForm" novalidate>
            <!-- Form Header -->
            <div class="mb-6 text-center">
                <h1 class="text-2xl font-bold text-white">Edit Smartlink</h1>
                <p class="text-sm text-gray-400" id="smartlinkIdDisplay">Loading...</p>
            </div>

            <!-- Smartlink Name -->
            <div class="mb-4">
                <label for="smartlinkName" class="form-label">Smartlink Name</label>
                <input type="text" id="smartlinkName" class="form-input" value="" required>
                <p id="nameValidation" class="validation-text text-red-500"></p>
            </div>

            <!-- Tracking Link (Read-only) -->
            <div class="mb-6">
                <label for="trackingLink" class="form-label">Your Tracking Link</label>
                <div class="relative">
                    <input type="text" id="trackingLink" class="form-input pr-10" value="" readonly>
                    <button type="button" id="copyButton" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-white">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>

            <!-- Custom Parameters Section -->
            <div class="mb-6 p-4 bg-[#1a1a1a] rounded-lg border border-[#2a2a2a]">
                 <h2 class="font-semibold text-lg mb-4 text-white">Add Your Parameters</h2>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="clickId" class="form-label">CLICK ID</label>
                        <input type="text" id="clickId" class="form-input" placeholder="{click_id}">
                    </div>
                    <div>
                        <label for="sub1" class="form-label">SUB 1</label>
                        <input type="text" id="sub1" class="form-input" placeholder="e.g., campaign_name">
                    </div>
                    <div>
                        <label for="sub2" class="form-label">SUB 2</label>
                        <input type="text" id="sub2" class="form-input" placeholder="e.g., creative_id">
                    </div>
                     <div>
                        <label for="sub3" class="form-label">SUB 3</label>
                        <input type="text" id="sub3" class="form-input" placeholder="e.g., placement_id">
                    </div>
                 </div>
            </div>

            <!-- Postback URL Section -->
            <div class="mb-6 p-4 bg-[#1a1a1a] rounded-lg border border-[#2a2a2a]">
                <h2 class="font-semibold text-lg mb-2 text-white">S2S Postback URL</h2>
                <p class="text-xs text-gray-400 mb-4">Get notified of conversions on your server. Leave blank if not used.</p>
                <label for="postbackUrl" class="form-label">Your Postback URL</label>
                <textarea id="postbackUrl" class="form-input" rows="3" placeholder="https://mytracker.com/p?cid={click_id}&payout={payout}"></textarea>
                <p id="postbackValidation" class="validation-text text-red-500"></p>
            </div>
            
            <!-- Save Button -->
            <div class="mt-8">
                <button type="submit" id="saveButton" class="save-button" disabled>
                    <i class="fas fa-save mr-2"></i>Save Changes
                </button>
            </div>
        </form>
    </div>

    <!-- Toast Notification Element -->
    <div id="toast">
        <i class="fas fa-check-circle mr-3"></i>
        <span>Saved Successfully!</span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Initialize Telegram Web App ---
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            tg.setHeaderColor('#121212');
            tg.setBackgroundColor('#121212');

            // --- DOM Element References ---
            const form = document.getElementById('smartlinkForm');
            const saveButton = document.getElementById('saveButton');
            const smartlinkIdDisplay = document.getElementById('smartlinkIdDisplay');
            const smartlinkNameInput = document.getElementById('smartlinkName');
            const trackingLinkInput = document.getElementById('trackingLink');
            const postbackUrlInput = document.getElementById('postbackUrl');
            const nameValidationText = document.getElementById('nameValidation');
            const postbackValidationText = document.getElementById('postbackValidation');
            const copyButton = document.getElementById('copyButton');
            const toast = document.getElementById('toast');

            let smartlinkId = null;

            // --- DYNAMIC DATA POPULATION ---
            function populateForm() {
                const params = new URLSearchParams(window.location.search);
                smartlinkId = params.get('id');
                const name = params.get('name');
                const link = params.get('link');
                const postback = params.get('postback');
                const clickId = params.get('clickId');
                const sub1 = params.get('sub1');
                const sub2 = params.get('sub2');
                const sub3 = params.get('sub3');

                if (smartlinkId) {
                    smartlinkIdDisplay.textContent = `ID: ${smartlinkId}`;
                    smartlinkNameInput.value = name ? decodeURIComponent(name) : '';
                    trackingLinkInput.value = link ? decodeURIComponent(link) : '';
                    postbackUrlInput.value = postback ? decodeURIComponent(postback) : '';
                    document.getElementById('clickId').value = clickId ? decodeURIComponent(clickId) : '';
                    document.getElementById('sub1').value = sub1 ? decodeURIComponent(sub1) : '';
                    document.getElementById('sub2').value = sub2 ? decodeURIComponent(sub2) : '';
                    document.getElementById('sub3').value = sub3 ? decodeURIComponent(sub3) : '';
                } else {
                    smartlinkIdDisplay.textContent = 'Error: No Smartlink ID provided.';
                    form.style.display = 'none'; // Hide form if no ID
                }
            }

            // --- Validation Logic ---
            const validators = {
                smartlinkName: (value) => value.trim() !== '',
                postbackUrl: (value) => value.trim() === '' || /^https?:\/\/[^\s$.?#].[^\s]*$/i.test(value)
            };

            function validateField(input, validator, validationTextElement) {
                const isValid = validator(input.value);
                if (input.value.trim() === '' && input !== smartlinkNameInput) {
                    input.classList.remove('is-invalid', 'is-valid');
                    validationTextElement.textContent = '';
                    return true;
                }
                if (isValid) {
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                    validationTextElement.textContent = '';
                } else {
                    input.classList.remove('is-valid');
                    input.classList.add('is-invalid');
                    validationTextElement.textContent = input === postbackUrlInput ? 'Please enter a valid URL.' : 'Name cannot be empty.';
                }
                return isValid;
            }

            function validateForm() {
                const isNameValid = validateField(smartlinkNameInput, validators.smartlinkName, nameValidationText);
                const isPostbackValid = validateField(postbackUrlInput, validators.postbackUrl, postbackValidationText);
                saveButton.disabled = !(isNameValid && isPostbackValid);
            }

            // --- Event Listeners ---
            form.addEventListener('input', validateForm);

            // --- Form Submission ---
            form.addEventListener('submit', function (event) {
                event.preventDefault();
                if (saveButton.disabled) return;

                const formData = {
                    id: smartlinkId, // Include the ID for backend processing
                    name: smartlinkNameInput.value,
                    clickId: document.getElementById('clickId').value,
                    sub1: document.getElementById('sub1').value,
                    sub2: document.getElementById('sub2').value,
                    sub3: document.getElementById('sub3').value,
                    postbackUrl: postbackUrlInput.value
                };
                
                toast.classList.add('show');
                tg.sendData(JSON.stringify({ status: 'success', formData: formData }));

                setTimeout(() => {
                    tg.close();
                }, 1500);
            });

            // --- Copy to Clipboard ---
            copyButton.addEventListener('click', function() {
                trackingLinkInput.select();
                document.execCommand('copy');
                const originalIcon = copyButton.innerHTML;
                copyButton.innerHTML = '<i class="fas fa-check text-green-500"></i>';
                setTimeout(() => {
                    copyButton.innerHTML = originalIcon;
                }, 1500);
            });

            // --- Initial Setup ---
            populateForm();
            validateForm();
        });
    </script>
</body>
</html>
